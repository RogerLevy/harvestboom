include config/options.vfx
include config/allegro.vfx
cwd ../vfxland3
include lib/vl3/vfxland3.vfx
include lib/csv.vfx
include lib/vl3/plugins/obj1.vfx
include lib/vl3/plugins/bitmaps2.vfx
cwd %idir%

-sin  \ disable tokenization of all definitions from here

%object sizeof
objvar tm-cols  \ scalar
objvar tm-rows  \ scalar
objvar tm-dcols  \ scalar
objvar tm-drows  \ scalar
objvar tm-base  \ addr
objvar tm-stride
objvar tm-scrollx  \ scalar
objvar tm-scrolly  \ scalar
objvar tm-tw  \ scalar
objvar tm-th  \ scalar
objvar tm-ts
create %tilemap ,

include ../vfxland3/lib/vl3/plugins/tilemap2.vfx
include ../vfxland3/lib/files1.vfx

\ ------------------------------------------------------------------------------

: read> ( $ c - <code> )  ( a c - )
    r/o[ bytes-left allocate throw
        dup bytes-left 2dup read  r> execute
        free throw
    ]file ;

create crlf 2 c, $0d c, $0a c, 
: lines> ( a c - <code> ) ( a c - )
    begin over >r crlf count search while
        over r> swap over - r@ execute
        2 /string
    repeat
    r> drop
    dup if  r@ execute  else  2drop  then
    r> drop ;

\ ------------------------------------------------------------------------------

: bytes ;
100 256 bytes create-pool p
: rnd  choose ;

\ ------------------------------------------------------------------------------

: static-map  create read> lines> csv> evaluate , ;
s" data/leveltest.csv" static-map testmap
z" data/castle-tileset.png" loadbmp constant castle.bmp
create castle.ts  castle.bmp 16 16 >tiles,
p constant tm
tm [[ testmap castle.ts 20 15 /tilemap ]]

: cls  0.5e 0.25e 0e 1e al_clear_to_color ;
: advance  each>  'step @ ?execute  -1 ;
: render  each>  x v@ at  'draw @ ?execute  -1 ; 
: present  display al_flip_display ;
: frame  p advance  cls  p render  present ;
: go  begin frame pause again ;

\ go